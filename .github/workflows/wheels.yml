name: Python Wheel Builds

on:
  push:

env:
  CIBUILDWHEEL_VERSION: 2.11.2
  CIBW_TEST_COMMAND: 'python -m unittest discover -v -s {project}/sme/test'
  CIBW_BUILD_VERBOSITY: 3
  SME_BUILD_CORE: 'false'

jobs:
  win64-wheel:
    name: Windows 64-bit Wheels
    runs-on: windows-2022
    defaults:
      run:
        shell: msys2 {0}
    env:
      CIBW_BUILD: '*-win_amd64'
      SME_EXTRA_CORE_DEFS: '_hypot=hypot;MS_WIN64'
      CIBW_TEST_SKIP: "pp3*-win_amd64"
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-ccache make
      - name: Set "latest" version number unless commit is tagged
        if: startsWith(github.event.ref, 'refs/tags/') == false
        run: ./ci/set-latest-version.sh ${GITHUB_SHA}
      - name: Cache ccache
        uses: actions/cache@v3
        with:
          path: D:\a\_temp\msys64\home\runneradmin\ccache
          key: ccache-${{ github.job }}-${{ runner.os }}-${{ github.sha }}
          restore-keys: ccache-${{ github.job }}-${{ runner.os }}-
      - name: Download static libraries
        run: ./ci/getlibs.sh win64-mingw
      - name: Build wheels
        run: ./ci/windows-wheels.sh
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          path: ./wheelhouse/*.whl
