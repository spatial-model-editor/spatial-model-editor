name: GUI/CLI Release Builds

on:
  push:

jobs:
  win64-gui:
    name: Windows 64-bit GUI/CLI
    runs-on: windows-2022
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-ccache make
      - name: Set "latest" version number unless commit is tagged
        if: startsWith(github.event.ref, 'refs/tags/') == false
        run: ./ci/set-latest-version.sh ${GITHUB_SHA}
      - name: Cache ccache
        uses: actions/cache@v3
        with:
          path: D:\a\_temp\msys64\home\runneradmin\ccache
          key: ccache-${{ github.job }}-${{ runner.os }}-${{ github.sha }}
          restore-keys: ccache-${{ github.job }}-${{ runner.os }}-
      - name: Get static libs
        run: ./ci/getlibs.sh win64-mingw
      - name: Build script
        run: ci/windows-gui.sh
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          path: ./artefacts/*
